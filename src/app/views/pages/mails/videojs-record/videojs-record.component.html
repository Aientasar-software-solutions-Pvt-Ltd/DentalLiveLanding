<div>
    <h5 *ngIf="!this.message" class="card-title pb-2 border-bottom" style="color: #011a3e">
        <a *ngIf="!isSchedule" [routerLink]="'/mail'"><i class="bx bxs-chevron-left me-2"></i></a>
        <a *ngIf="isSchedule" [routerLink]="'/meet'"><i class="bx bxs-chevron-left me-2"></i></a>
        {{!isSchedule?"Compose Mail":"Schedule Meeting"}}
    </h5>
    <h5 *ngIf="this.message" class="card-title pb-3 mb-4 ms-1 border-bottom" style="color: #011a3e">
        <span>Reply Mail</span><i style="cursor: pointer" [hidden]="sending" (click)="closeComp.emit(true)" class="fa fa-times float-end" aria-hidden="true"></i>
    </h5>
    <div *ngIf="sending" class="col-md-12">
        <lottie-player class="mt-3 m-auto" src="https://assets8.lottiefiles.com/packages/lf20_KwVaqs.json" background="transparent" speed="1" style="width: 300px; height: 300px" loop
                       autoplay></lottie-player>
        <h6 class="text-center mt-5">
            Sending Email....please wait,dont close this page
        </h6>
    </div>

    <div *ngIf="patientId" class="page-header d-sm-flex">
        <div class="d-sm-flex d-block align-items-center">
            <div class="profile-img justify-content-center p-md-2 me-3">
                <img style="width: 100px;height: 100px;border-radius: 150px;max-width: 100px;" [src]="
                                        getPatientObject(patientId)?.image
                                          ? newUtility.apiData.patients.bucketUrl +
                                            getPatientObject(patientId)?.image
                                          : '../../assets/images/users.png'" alt="" class="mb-2">
            </div>
            <div class="d-inline-block">
                <h3 class="fw-normal">{{getPatientObject(patientId)?.firstName+"
                    "+getPatientObject(patientId)?.lastName}}
                    <small>({{getPatientObject(patientId)?.dob
                        ? (getPatientObject(patientId).dob | date : 'mediumDate')
                        : null}})</small>
                </h3>
                <div class="text-blue" *ngIf="patientObject?.practiceId"><strong>{{newUtility
                        .getMetaData(
                        getPatientObject(patientId)?.practiceId,
                        "practiceId",
                        ["practiceName"],
                        "practices"
                        )}}</strong></div>
                <div><strong>{{getCaseObject(caseId)?.title}}</strong></div>
            </div>
        </div>
    </div>

    <div [hidden]="sending" class="page_card pt-2">
        <form #f="ngForm" (ngSubmit)="onSubmit(f)" novalidate>
            <div class="row">
                <div class="col-md-12">
                    <ng-container *ngIf="!this.message">
                        <div class="form-floating mb-3">
                            <select [disabled]="isPatientDisable" #patient (change)="addPatient(patient.value)" class="form-select" id="floatingSelect" [(ngModel)]="patientId" id="patientId"
                                    name="patientId">
                                <option selected value="">No Patient</option>
                                <option *ngFor="let patient of patientList" [value]="patient.patientId">
                                    {{ patient.firstName + " " + patient.lastName }}
                                </option>
                            </select>
                        </div>
                        <div class="form-floating mb-3">
                            <select [disabled]="!patient.value || isCaseDisabled" #case class="form-select" id="floatingSelect" [(ngModel)]="caseId" id="caseId" name="caseId">
                                <option selected value="">No Case</option>
                                <option *ngFor="let case of caseList" [value]="case.caseId">
                                    {{ case.title }}
                                </option>
                            </select>
                        </div>
                    </ng-container>
                    <div class="form-floating mb-3">
                        <div class="d-flex form-control flex-wrap h-auto pt-2" [ngClass]="{'ng-invalid': addressList.length == 0 && toAddress.value == '','ng-touched': istouched}"
                             (click)="toAddress.focus()">
                            <small *ngFor="let mail of addressList; let i = index" style="font-size: 12px; font-weight: 100"
                                   class="badge bg-light text-dark border-2 rounded-pill border align-self-center p-1 m-1 mb-3">{{
                                mail
                                }}<i (click)="addressList.splice(i, 1)" class="fa fa-times m-1"></i></small>

                            <input (blur)="istouched = true" #toAddress type="email" [matAutocomplete]="auto" autocomplete="email" pattern="^[^\s@]+@[^\s@]+\.[^\s@]+$"
                                   (keydown)="addMail($event, $any($event.target).value, toAddress)" (blur)="addtoList($any($event.target).value, toAddress, auto)"
                                   (keyup)="filterContact($any($event.target).value)"
                                   class="form-control border-0 p-0 m-0 h-auto w-100 shadow-none" id="floatingInput" [(ngModel)]="mail.toAddresses" placeholder="To (Seperated by commas)"
                                   name="toAddresses" [required]="addressList.length == 0 && toAddress.value == ''" />

                            <mat-autocomplete (optionSelected)="
                  addMailOption($any($event.option).value, toAddress)
                " class="w-100" #auto="matAutocomplete">
                                <mat-option *ngFor="let contact of contactFilterdList" [value]="contact.email">
                                    {{
                                    contact.firstName +
                                    " " +
                                    contact.lastName +
                                    " \<" + contact.email + ">" }} </mat-option>
                            </mat-autocomplete>
                        </div>
                        <!-- <label for="floatingInput">To<small>
                (Seperated by commas or hit enter for multiple email
                address)</small></label> -->
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" [(ngModel)]="mail.ccAddresses" name="ccAddresses" class="form-control" id="floatingInput" placeholder="CC Addresses" />
                        <label for="floatingInput">CC Address<small> (Optional-Seperated by commas)</small>
                        </label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" [(ngModel)]="mail.bccAddresses" name="bccAddresses" class="form-control" id="floatingInput" placeholder="BCC Addresses" />
                        <label for="floatingInput">BCC Address<small> (Optional-Seperated by commas)</small>
                        </label>
                    </div>


                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="floatingInput" placeholder="Subject" [(ngModel)]="mail.subject" name="subject" required />
                        <label for="floatingInput">Subject : </label>
                    </div>

                    <div *ngIf="isSchedule" class="row">
                        <div class="form-floating mb-3 col-md-6">
                            <input type="datetime-local" class="form-control" id="floatingInput" placeholder="Start Date" ngModel name="startDate" required />
                            <label class="ms-2" for="floatingInput">Start Date : </label>
                        </div>
                        <div class="form-floating mb-3 col-md-6">
                            <input type="datetime-local" class="form-control" id="floatingInput" placeholder="End Date" ngModel name="endDate" required />
                            <label class="ms-2" for="floatingInput">End Date : </label>
                        </div>

                    </div>

                    <div [hidden]="!isSchedule" class="input-group  mb-3">
                        <input type="text" class="form-control" #location id="floatingInput" placeholder="Custom Meeting Location (Optional)" ngModel name="location" />
                        <button type="button" (click)="assign3X(location,true)" class="btn btn-default mx-2">Add 3cx
                            Meeting</button>
                        <button type="button" (click)="assign3X(location,false)" class="btn btn-pink me-2">Delete 3cx
                            Meeting</button>
                    </div>

                    <div class="form-floating mb-3">
                        <div class="form-control h-auto">
                            <div contenteditable="true" style="min-height: 100px; overflow: auto" id="message"></div>
                            <div *ngIf="mail.trail && mail.trail != ''" class="ellipsis mt-2">
                                <span class="badge rounded-pill bg-light text-dark" data-bs-toggle="collapse" [attr.data-bs-target]="'#trail'"><i class="fa fa-ellipsis-h"
                                       aria-hidden="true"></i></span>
                                <div class="collapse border mt-2 rounded p-2 body2" id="trail" editable contenteditable="true">
                                    <div>
                                        <br /><br />On
                                        {{ message.mailDateTime | date : "medium" }} ','
                                        {{ message.MailFrom }} + wrote:<br />
                                    </div>
                                    <blockquote [innerHTML]="sanitizer.bypassSecurityTrustHtml(mail.trail)">
                                    </blockquote>
                                </div>
                            </div>
                        </div>
                        <label for="message">Message <small> (Optional)</small></label>
                    </div>
                </div>
            </div>
            <div class="col-md-12 mb-5">
                <label class="form-label body2 text-dark">Attachments </label>
                <app-cvfast-new (getEmoji)="poplEmoji($event)" [isHideText]="true" #cvfast></app-cvfast-new>
            </div>
            <div class="row mt-4">
                <div *ngIf="!isSchedule" class="row border-bottom pb-3 mb-3">
                    <div class="col-md-12">
                        <label class="text-danger fw-bold  my-2">
                            Note : Do not send Patient Health Information in this Mail
                        </label>
                        <!-- <div class="form-check">
              <input class="form-check-input" type="checkbox" value="" id="agreeTerms">
              <label class="form-check-label" for="agreeTerms">
                I agree to the accompanying.<label style="color:#00D9CC;" class="ms-1">Attachment copyrights</label>
              </label>
            </div> -->
                    </div>
                </div>
                <div class="row d-flex row justify-content-between p-2">
                    <div class="col">
                        <button type="submit" class="btn btn-primary add me-2" style="line-height: 12px">
                            Send
                        </button>
                        <a *ngIf="isSchedule" routerLink="/meet" type="button" class="btn btn-outline-primary cancel" style="border-color: #00d9cc; text-transform: capitalize">Discard</a>

                        <a *ngIf="!isSchedule" routerLink="/mail/inbox" type="button" class="btn btn-outline-primary cancel" style="border-color: #00d9cc; text-transform: capitalize">Discard</a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>